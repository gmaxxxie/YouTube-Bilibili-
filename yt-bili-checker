// ==UserScript==
// @name         YouTube ä¸€é”®è·³è½¬ Bilibili åŒåè§†é¢‘ v2.3
// @namespace    https://github.com/your-username/yt-bili-checker
// @version      2.3.0
// @description  åœ¨ YouTube ç½‘ç«™ä¸Šè‡ªåŠ¨æ£€æµ‹å½“å‰è§†é¢‘åœ¨ Bilibili æ˜¯å¦æœ‰åŒåè§†é¢‘ï¼Œæ˜¾ç¤ºå‰5ä¸ªæœç´¢ç»“æœä¾›ç”¨æˆ·é€‰æ‹© - ä¿®å¤é¢æ¿çŠ¶æ€ç®¡ç†
// @author       Maxxie wei
// @license      MIT
// @match        *://www.youtube.com/*
// @match        *://youtube.com/*
// @grant        GM_xmlhttpRequest
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_registerMenuCommand
// @connect      api.bilibili.com
// @connect      www.bilibili.com
// @connect      search.bilibili.com
// @connect      s.search.bilibili.com
// @icon         https://www.google.com/s2/favicons?domain=www.youtube.com
// @downloadURL  https://raw.githubusercontent.com/your-username/yt-bili-checker/main/youtube-to-bilibili-v2.user.js
// @updateURL    https://raw.githubusercontent.com/your-username/yt-bili-checker/main/youtube-to-bilibili-v2.user.js
// ==/UserScript==

(function() {
    'use strict';

    // é…ç½®å¸¸é‡
    const CONFIG = {
        BUTTON_ID: 'yt-bili-finder-button-v2',
        RESULTS_PANEL_ID: 'yt-bili-results-panel-v2',
        NOTIFICATION_ID: 'yt-bili-notification-v2',
        DEFAULT_THRESHOLD: 0.3,
        SEARCH_DELAY: 2000,
        NOTIFICATION_DURATION: 5000,
        CACHE_DURATION: 5 * 60 * 1000, // 5åˆ†é’Ÿ
        MAX_SEARCH_RESULTS: 5
    };

    // å…¨å±€å˜é‡
    let lastUrl = '';
    let mainLogicInterval;
    let currentVideoTitle = '';
    let searchCache = new Map();
    let currentSearchResult = null; // å­˜å‚¨å½“å‰æœç´¢ç»“æœ

    /**
     * ä¼˜åŒ–çš„åŒ¹é…ç®—æ³•
     */
    class OptimizedMatcher {
        constructor() {
            this.threshold = GM_getValue('similarity_threshold', CONFIG.DEFAULT_THRESHOLD);
        }

        /**
         * æ ‡å‡†åŒ–æ ‡é¢˜æ–‡æœ¬
         */
        normalizeTitle(str) {
            if (!str) return '';
            return str
                .toLowerCase()
                .replace(/[^\p{L}\p{N}\s]/gu, '')
                .replace(/\s+/g, ' ')
                .trim();
        }

        /**
         * è®¡ç®—ä¸¤ä¸ªå­—ç¬¦ä¸²çš„ç›¸ä¼¼åº¦ - ä½¿ç”¨æ”¹è¿›çš„ç®—æ³•
         */
        calculateStringSimilarity(str1, str2) {
            const s1 = this.normalizeTitle(str1);
            const s2 = this.normalizeTitle(str2);

            if (s1 === s2) return 1.0;
            if (s1.length < 2 || s2.length < 2) return 0.0;

            // è®¡ç®—å…±åŒå­—ç¬¦æ•°å’Œä½ç½®åŒ¹é…
            const chars1 = new Set(s1.split(''));
            const chars2 = new Set(s2.split(''));
            
            let commonChars = 0;
            for (const char of chars1) {
                if (chars2.has(char)) {
                    commonChars++;
                }
            }

            // åŸºç¡€ç›¸ä¼¼åº¦
            const baseSimilarity = (2.0 * commonChars) / (chars1.size + chars2.size);
            
            // é•¿åº¦ç›¸ä¼¼åº¦
            const lengthSimilarity = Math.min(s1.length, s2.length) / Math.max(s1.length, s2.length);
            
            // ç»¼åˆç›¸ä¼¼åº¦
            return (baseSimilarity * 0.7 + lengthSimilarity * 0.3);
        }

        /**
         * æ›´æ–°åŒ¹é…é˜ˆå€¼
         */
        updateThreshold(newThreshold) {
            if (newThreshold < 0.0 || newThreshold > 1.0) {
                throw new Error('é˜ˆå€¼å¿…é¡»åœ¨0.0åˆ°1.0ä¹‹é—´');
            }
            
            this.threshold = newThreshold;
            GM_setValue('similarity_threshold', newThreshold);
            console.log(`åŒ¹é…é˜ˆå€¼å·²æ›´æ–°ä¸º: ${(newThreshold * 100).toFixed(1)}%`);
        }
    }

    /**
     * ç®€åŒ–çš„æ ‡é¢˜å¤„ç†å·¥å…·
     */
    class SimpleTitleProcessor {
        /**
         * æ¸…ç†æ ‡é¢˜ä¸­çš„æ— ç”¨ä¿¡æ¯
         */
        cleanTitle(title) {
            if (!title) return '';
            
            return title
                .replace(/\[.*?\]/g, '') // ç§»é™¤æ–¹æ‹¬å·å†…å®¹
                .replace(/ã€.*?ã€‘/g, '') // ç§»é™¤ä¸­æ–‡æ–¹æ‹¬å·å†…å®¹
                .replace(/\(.*?\)/g, '') // ç§»é™¤åœ†æ‹¬å·å†…å®¹
                .replace(/ï¼ˆ.*?ï¼‰/g, '') // ç§»é™¤ä¸­æ–‡åœ†æ‹¬å·å†…å®¹
                .replace(/[ã€ã€‘\[\]()ï¼ˆï¼‰]/g, '') // ç§»é™¤æ‰€æœ‰æ‹¬å·
                .replace(/\s+/g, ' ') // åˆå¹¶å¤šä¸ªç©ºæ ¼
                .trim();
        }

        /**
         * ç”Ÿæˆæœç´¢å…³é”®è¯ - ç›´æ¥ä½¿ç”¨æ¸…ç†åçš„æ ‡é¢˜
         */
        generateSearchKeywords(title) {
            const cleanedTitle = this.cleanTitle(title);
            return {
                fullTitle: cleanedTitle,
                originalTitle: title
            };
        }
    }

    // åˆå§‹åŒ–å·¥å…·ç±»
    const matcher = new OptimizedMatcher();
    const titleProcessor = new SimpleTitleProcessor();

    /**
     * è®¾ç½®èœå•å‘½ä»¤
     */
    function setupMenuCommands() {
        GM_registerMenuCommand('è®¾ç½®åŒ¹é…é˜ˆå€¼', () => {
            const currentThreshold = GM_getValue('similarity_threshold', CONFIG.DEFAULT_THRESHOLD);
            const userInput = prompt('è¯·è¾“å…¥æ–°çš„åŒ¹é…é˜ˆå€¼ (èŒƒå›´ 0.0 - 1.0):', currentThreshold);
            
            if (userInput === null) return;
            
            const newThreshold = parseFloat(userInput);
            if (isNaN(newThreshold) || newThreshold < 0.0 || newThreshold > 1.0) {
                alert('è¾“å…¥æ— æ•ˆï¼è¯·è¾“å…¥ä¸€ä¸ªä»‹äº 0.0 å’Œ 1.0 ä¹‹é—´çš„æ•°å­—ã€‚');
                return;
            }
            
            try {
                matcher.updateThreshold(newThreshold);
                alert(`åŒ¹é…é˜ˆå€¼å·²æˆåŠŸä¿å­˜ä¸º: ${(newThreshold * 100).toFixed(1)}%`);
            } catch (error) {
                alert('è®¾ç½®å¤±è´¥: ' + error.message);
            }
        });

        GM_registerMenuCommand('æ¸…é™¤æœç´¢ç¼“å­˜', () => {
            searchCache.clear();
            alert('æœç´¢ç¼“å­˜å·²æ¸…é™¤ï¼');
        });

        GM_registerMenuCommand('æŸ¥çœ‹å½“å‰è®¾ç½®', () => {
            const threshold = GM_getValue('similarity_threshold', CONFIG.DEFAULT_THRESHOLD);
            alert(`å½“å‰åŒ¹é…é˜ˆå€¼: ${(threshold * 100).toFixed(1)}%\nç¼“å­˜å¤§å°: ${searchCache.size}\næœç´¢ç»“æœæ•°: ${CONFIG.MAX_SEARCH_RESULTS}`);
        });

        // æ–°å¢ï¼šæ‰‹åŠ¨æœç´¢å½“å‰è§†é¢‘
        GM_registerMenuCommand('æ‰‹åŠ¨æœç´¢å½“å‰è§†é¢‘', () => {
            const videoTitle = getVideoTitle();
            if (videoTitle) {
                console.log("YT-Bili v2: æ‰‹åŠ¨æœç´¢è§†é¢‘:", videoTitle);
                updateButtonToSearching();
                searchBilibili(videoTitle);
            } else {
                alert('æœªèƒ½è·å–å½“å‰è§†é¢‘æ ‡é¢˜');
            }
        });

        // æ–°å¢ï¼šç›´æ¥è·³è½¬åˆ°Bilibiliæœç´¢é¡µé¢
        GM_registerMenuCommand('ç›´æ¥è·³è½¬Bilibiliæœç´¢', () => {
            const videoTitle = getVideoTitle();
            if (videoTitle) {
                const searchKeywords = titleProcessor.generateSearchKeywords(videoTitle);
                const searchUrl = `https://search.bilibili.com/video?keyword=${encodeURIComponent(searchKeywords.fullTitle)}`;
                window.open(searchUrl, '_blank');
            } else {
                alert('æœªèƒ½è·å–å½“å‰è§†é¢‘æ ‡é¢˜');
            }
        });

        // æ–°å¢ï¼šæµ‹è¯•APIè¿æ¥
        GM_registerMenuCommand('æµ‹è¯•Bilibili APIè¿æ¥', () => {
            console.log("YT-Bili v2: å¼€å§‹æµ‹è¯•APIè¿æ¥...");
            testBilibiliAPI();
        });
    }

    /**
     * ä¸»é€»è¾‘ - URLä¾¦æµ‹å™¨
     */
    function startUrlDetection() {
        let lastVideoId = '';
        
        setInterval(() => {
            const currentUrl = window.location.href;
            const currentVideoId = getVideoId();
            
            // æ£€æŸ¥URLå˜åŒ–æˆ–è§†é¢‘IDå˜åŒ–
            if (currentUrl !== lastUrl || currentVideoId !== lastVideoId) {
                console.log("YT-Bili v2: æ£€æµ‹åˆ°å˜åŒ–ï¼Œå‡†å¤‡åˆ·æ–°æŒ‰é’®...");
                console.log("URLå˜åŒ–:", currentUrl !== lastUrl);
                console.log("è§†é¢‘IDå˜åŒ–:", currentVideoId !== lastVideoId);
                lastUrl = currentUrl;
                lastVideoId = currentVideoId;
                runMainLogic();
            }
        }, 1000);
    }

    /**
     * è·å–å½“å‰è§†é¢‘ID
     */
    function getVideoId() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('v') || '';
    }

    /**
     * è¿è¡Œä¸»é€»è¾‘
     */
    function runMainLogic() {
        clearInterval(mainLogicInterval);
        removeExistingElements();
        
        mainLogicInterval = setInterval(() => {
            if (isVideoPage()) {
                const videoTitle = getVideoTitle();
                if (videoTitle && videoTitle !== currentVideoTitle) {
                    console.log("YT-Bili v2: æ£€æµ‹åˆ°æ–°è§†é¢‘æ ‡é¢˜:", videoTitle);
                    clearInterval(mainLogicInterval);
                    createAndSearch();
                } else if (videoTitle && !document.getElementById(CONFIG.BUTTON_ID)) {
                    console.log("YT-Bili v2: é¦–æ¬¡åŠ è½½è§†é¢‘ï¼Œåˆ›å»ºæŒ‰é’®");
                    clearInterval(mainLogicInterval);
                    createAndSearch();
                }
            }
        }, 500);
    }

    /**
     * æ£€æŸ¥æ˜¯å¦ä¸ºè§†é¢‘é¡µé¢
     */
    function isVideoPage() {
        return window.location.pathname === '/watch' && window.location.search.includes('v=');
    }

    /**
     * ç§»é™¤å·²å­˜åœ¨çš„å…ƒç´ 
     */
    function removeExistingElements() {
        document.getElementById(CONFIG.BUTTON_ID)?.remove();
        document.getElementById(CONFIG.RESULTS_PANEL_ID)?.remove();
        document.getElementById(CONFIG.NOTIFICATION_ID)?.remove();
        
        // é‡ç½®æœç´¢ç»“æœçŠ¶æ€
        currentSearchResult = null;
    }

    /**
     * åˆ›å»ºæŒ‰é’®å¹¶å‡†å¤‡æœç´¢
     */
    function createAndSearch() {
        if (document.getElementById(CONFIG.BUTTON_ID)) return;
        
        console.log("YT-Bili v2: æ‰¾åˆ°è§†é¢‘é¡µé¢ï¼Œæ­£åœ¨æ³¨å…¥æŒ‰é’®...");
        
        const videoTitle = getVideoTitle();
        if (!videoTitle) {
            console.log("YT-Bili v2: æœªèƒ½è·å–è§†é¢‘æ ‡é¢˜ï¼Œç­‰å¾…é¡µé¢åŠ è½½...");
            // å¦‚æœæ ‡é¢˜è¿˜æ²¡åŠ è½½ï¼Œç­‰å¾…ä¸€ä¸‹å†è¯•
            setTimeout(() => {
                const retryTitle = getVideoTitle();
                if (retryTitle) {
                    console.log("YT-Bili v2: é‡è¯•è·å–è§†é¢‘æ ‡é¢˜æˆåŠŸ:", retryTitle);
                    currentVideoTitle = retryTitle;
                    createSearchButton();
                } else {
                    console.log("YT-Bili v2: é‡è¯•åä»æœªè·å–åˆ°è§†é¢‘æ ‡é¢˜");
                }
            }, 2000);
            return;
        }

        currentVideoTitle = videoTitle;
        createSearchButton();
        
        // è®¾ç½®æ ‡é¢˜å˜åŒ–ç›‘å¬
        setupTitleChangeListener();
    }

    /**
     * è®¾ç½®æ ‡é¢˜å˜åŒ–ç›‘å¬å™¨
     */
    function setupTitleChangeListener() {
        // ç›‘å¬é¡µé¢å†…å®¹å˜åŒ–
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'childList') {
                    const videoTitle = getVideoTitle();
                    if (videoTitle && videoTitle !== currentVideoTitle) {
                        console.log("YT-Bili v2: æ£€æµ‹åˆ°æ ‡é¢˜å˜åŒ–:", videoTitle);
                        currentVideoTitle = videoTitle;
                        removeExistingElements();
                        createSearchButton();
                        // ä¸å†è‡ªåŠ¨æœç´¢ï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»
                    }
                }
            });
        });

        // ç›‘å¬æ•´ä¸ªæ–‡æ¡£çš„å˜åŒ–
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    }

    /**
     * è·å–YouTubeè§†é¢‘æ ‡é¢˜
     */
    function getVideoTitle() {
        const selectors = [
            'h1.ytd-video-primary-info-renderer',
            'h1.ytd-watch-metadata',
            'h1.title',
            '.ytd-video-primary-info-renderer h1',
            'h1[class*="title"]',
            'h1.ytd-video-primary-info-renderer yt-formatted-string',
            'h1.ytd-watch-metadata yt-formatted-string'
        ];

        for (const selector of selectors) {
            const element = document.querySelector(selector);
            if (element && element.textContent.trim()) {
                return element.textContent.trim();
            }
        }

        return null;
    }

    /**
     * åˆ›å»ºæœç´¢æŒ‰é’®
     */
    function createSearchButton() {
        const button = document.createElement('div');
        button.id = CONFIG.BUTTON_ID;
        button.innerHTML = `
            <div style="
                position: fixed;
                top: 12px;
                right: 240px;
                background: linear-gradient(135deg, #00a1d6, #fb7299);
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                font-size: 12px;
                cursor: pointer;
                opacity: 0.9;
                transition: opacity 0.3s;
                white-space: nowrap;
                z-index: 10000;
            " onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.9'">
                ğŸ” Bilibili
            </div>
        `;
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
        button.onclick = (event) => {
            // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…å½±å“YouTubeæ’­æ”¾
            event.preventDefault();
            event.stopPropagation();
            
            if (currentVideoTitle) {
                console.log("YT-Bili v2: ç”¨æˆ·ç‚¹å‡»æœç´¢æŒ‰é’®ï¼Œå¼€å§‹æœç´¢:", currentVideoTitle);
                updateButtonToSearching();
                searchBilibili(currentVideoTitle);
            } else {
                console.log("YT-Bili v2: å½“å‰è§†é¢‘æ ‡é¢˜ä¸ºç©ºï¼Œæ— æ³•æœç´¢");
                alert('æœªèƒ½è·å–å½“å‰è§†é¢‘æ ‡é¢˜ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        };
        
        // ç›´æ¥æ·»åŠ åˆ°bodyï¼Œä½¿ç”¨å›ºå®šå®šä½
        document.body.appendChild(button);
        console.log("YT-Bili v2: æŒ‰é’®å·²æ·»åŠ åˆ°é¡µé¢é¡¶éƒ¨");
    }

    /**
     * æ›´æ–°æŒ‰é’®ä¸ºæœç´¢ä¸­çŠ¶æ€
     */
    function updateButtonToSearching() {
        const button = document.getElementById(CONFIG.BUTTON_ID);
        if (!button) return;
        
        button.innerHTML = `
            <div style="
                position: fixed;
                top: 12px;
                right: 240px;
                background: linear-gradient(135deg, #FF9800, #FFC107);
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                font-size: 12px;
                cursor: pointer;
                opacity: 0.9;
                transition: opacity 0.3s;
                white-space: nowrap;
                z-index: 10000;
            " onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.9'">
                â³ æœç´¢ä¸­...
            </div>
        `;
    }

    /**
     * æš‚åœYouTubeè§†é¢‘æ’­æ”¾
     */
    function pauseYouTubeVideo() {
        try {
            // å°è¯•å¤šç§æ–¹å¼æš‚åœYouTubeè§†é¢‘
            const video = document.querySelector('video');
            if (video && !video.paused) {
                video.pause();
                console.log("YT-Bili v2: å·²æš‚åœYouTubeè§†é¢‘æ’­æ”¾");
            }
            
            // å°è¯•ç‚¹å‡»æš‚åœæŒ‰é’®
            const pauseButton = document.querySelector('.ytp-play-button[aria-label*="æš‚åœ"], .ytp-play-button[aria-label*="Pause"]');
            if (pauseButton && pauseButton.getAttribute('aria-label').includes('æ’­æ”¾')) {
                pauseButton.click();
                console.log("YT-Bili v2: å·²ç‚¹å‡»æš‚åœæŒ‰é’®");
            }
        } catch (error) {
            console.log("YT-Bili v2: æš‚åœè§†é¢‘æ—¶å‡ºç°é”™è¯¯:", error);
        }
    }

    /**
     * åœ¨Bilibiliæœç´¢è§†é¢‘ - åŸºäºå®˜æ–¹APIæ–‡æ¡£ä¼˜åŒ–ï¼Œæ”¯æŒCookieè·å–
     */
    function searchBilibili(query) {
        // æ£€æŸ¥ç¼“å­˜
        const cacheKey = query.toLowerCase().trim();
        const cachedResult = searchCache.get(cacheKey);
        if (cachedResult && Date.now() - cachedResult.timestamp < CONFIG.CACHE_DURATION) {
            console.log("YT-Bili v2: ä½¿ç”¨ç¼“å­˜ç»“æœ");
            handleSearchResult(cachedResult.data);
            return;
        }

        const searchKeywords = titleProcessor.generateSearchKeywords(query);
        console.log("--- YT-Bili v2 å¼€å§‹æŸ¥æ‰¾ ---");
        console.log(`YouTubeåŸå§‹æ ‡é¢˜: ${query}`);
        console.log(`æ¸…ç†åæ ‡é¢˜: ${searchKeywords.fullTitle}`);
        console.log(`å½“å‰åŒ¹é…é˜ˆå€¼: ${(matcher.threshold * 100).toFixed(1)}%`);
        console.log(`æœç´¢å‰${CONFIG.MAX_SEARCH_RESULTS}ä¸ªç»“æœ`);

        // é¦–å…ˆè·å–Bç«™cookiesï¼Œè§£å†³412é”™è¯¯
        getBilibiliCookies().then(() => {
            // ä½¿ç”¨æ–°çš„ç»¼åˆæœç´¢API
            const searchUrl = `https://api.bilibili.com/x/web-interface/wbi/search/all/v2?keyword=${encodeURIComponent(searchKeywords.fullTitle)}&page=1&pagesize=${CONFIG.MAX_SEARCH_RESULTS}`;
            
            GM_xmlhttpRequest({
                method: 'GET',
                url: searchUrl,
                headers: {
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                    'Referer': 'https://www.bilibili.com/',
                    'Accept': 'application/json, text/plain, */*',
                    'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
                    'Accept-Encoding': 'gzip, deflate, br',
                    'Connection': 'keep-alive',
                    'Sec-Fetch-Dest': 'empty',
                    'Sec-Fetch-Mode': 'cors',
                    'Sec-Fetch-Site': 'same-site',
                    'Origin': 'https://www.bilibili.com'
                },
                onload: function(response) {
                    console.log("YT-Bili v2: APIå“åº”çŠ¶æ€:", response.status);
                    console.log("YT-Bili v2: APIå“åº”å†…å®¹:", response.responseText.substring(0, 500));
                    
                    if (response.status >= 200 && response.status < 300) {
                        try {
                            const data = JSON.parse(response.responseText);
                            console.log("YT-Bili v2: è§£æçš„APIæ•°æ®:", data);
                            
                            if (data.code === 0 && data.data && data.data.result) {
                                // æ–°APIè¿”å›çš„æ˜¯ç»¼åˆæœç´¢ç»“æœï¼Œéœ€è¦æå–è§†é¢‘éƒ¨åˆ†
                                const allResults = data.data.result;
                                let videos = [];
                                
                                // æå–è§†é¢‘ç»“æœ - å¤„ç†æ–°APIçš„æ•°æ®ç»“æ„
                                if (allResults.video && allResults.video.data) {
                                    videos = allResults.video.data.slice(0, CONFIG.MAX_SEARCH_RESULTS);
                                } else if (allResults.result && allResults.result.video && allResults.result.video.data) {
                                    // å¦ä¸€ç§å¯èƒ½çš„åµŒå¥—ç»“æ„
                                    videos = allResults.result.video.data.slice(0, CONFIG.MAX_SEARCH_RESULTS);
                                } else if (Array.isArray(allResults)) {
                                    // å¦‚æœç›´æ¥æ˜¯è§†é¢‘æ•°ç»„
                                    videos = allResults.slice(0, CONFIG.MAX_SEARCH_RESULTS);
                                } else if (allResults.result && Array.isArray(allResults.result)) {
                                    // å¦‚æœresultæ˜¯æ•°ç»„
                                    videos = allResults.result.slice(0, CONFIG.MAX_SEARCH_RESULTS);
                                }
                                
                                // ç¡®ä¿è§†é¢‘æ•°æ®æ ¼å¼æ­£ç¡®
                                videos = videos.filter(video => video && video.title && video.bvid);
                                
                                console.log(`YT-Bili v2: æ‰¾åˆ° ${videos.length} ä¸ªBilibiliè§†é¢‘ï¼ˆå‰${CONFIG.MAX_SEARCH_RESULTS}ä¸ªï¼‰`);
                                
                                if (videos.length > 0) {
                                    // è®¡ç®—æ¯ä¸ªè§†é¢‘çš„ç›¸ä¼¼åº¦å¹¶è¿‡æ»¤ä½åŒ¹é…åº¦ç»“æœ
                                    const rankedVideos = videos.map((video, index) => {
                                        const similarity = matcher.calculateStringSimilarity(query, video.title);
                                        console.log(`YT-Bili v2: [${index + 1}/5] "${video.title}" - ç›¸ä¼¼åº¦: ${(similarity * 100).toFixed(1)}%`);
                                        return {
                                            ...video,
                                            similarity: similarity,
                                            rank: index + 1
                                        };
                                    })
                                    .filter(video => video.similarity >= matcher.threshold) // è¿‡æ»¤ä½åŒ¹é…åº¦ç»“æœ
                                    .sort((a, b) => b.similarity - a.similarity)
                                    .slice(0, CONFIG.MAX_SEARCH_RESULTS); // é™åˆ¶æ˜¾ç¤ºæ•°é‡
                                    
                                    console.log(`YT-Bili v2: è¿‡æ»¤åå‰©ä½™ ${rankedVideos.length} ä¸ªåŒ¹é…ç»“æœ`);
                                    
                                    const result = {
                                        videos: rankedVideos,
                                        totalSearched: videos.length,
                                        threshold: matcher.threshold,
                                        originalTitle: query
                                    };
                                    
                                    // ç¼“å­˜ç»“æœ
                                    searchCache.set(cacheKey, {
                                        data: result,
                                        timestamp: Date.now()
                                    });
                                    
                                    handleSearchResult(result);
                                } else {
                                    console.log("YT-Bili v2: æ–°APIè¿”å›æ— è§†é¢‘ç»“æœ");
                                    // å°è¯•å¤‡ç”¨æœç´¢æ–¹æ³•
                                    tryAlternativeSearch(query, searchKeywords.fullTitle);
                                }
                            } else {
                                console.log("YT-Bili v2: APIè¿”å›é”™è¯¯ï¼Œé”™è¯¯ä¿¡æ¯:", data);
                                // å°è¯•å¤‡ç”¨æœç´¢æ–¹æ³•
                                tryAlternativeSearch(query, searchKeywords.fullTitle);
                            }
                        } catch (error) {
                            console.error("YT-Bili v2: è§£æå“åº”å¤±è´¥:", error);
                            // å°è¯•å¤‡ç”¨æœç´¢æ–¹æ³•
                            tryAlternativeSearch(query, searchKeywords.fullTitle);
                        }
                    } else {
                        console.error("YT-Bili v2: APIè¯·æ±‚å¤±è´¥:", response.status);
                        // å°è¯•å¤‡ç”¨æœç´¢æ–¹æ³•
                        tryAlternativeSearch(query, searchKeywords.fullTitle);
                    }
                },
                onerror: function(error) {
                    console.error("YT-Bili v2: ç½‘ç»œè¯·æ±‚å¤±è´¥:", error);
                    // å°è¯•å¤‡ç”¨æœç´¢æ–¹æ³•
                    tryAlternativeSearch(query, searchKeywords.fullTitle);
                }
            });
        }).catch(error => {
            console.error("YT-Bili v2: è·å–cookieså¤±è´¥:", error);
            // ç›´æ¥å°è¯•å¤‡ç”¨æœç´¢æ–¹æ³•
            tryAlternativeSearch(query, searchKeywords.fullTitle);
        });
    }

    /**
     * è·å–Bç«™cookies - è§£å†³412é”™è¯¯
     */
    function getBilibiliCookies() {
        return new Promise((resolve, reject) => {
            console.log("YT-Bili v2: å¼€å§‹è·å–Bç«™cookies...");
            
            GM_xmlhttpRequest({
                method: 'GET',
                url: 'https://www.bilibili.com/',
                headers: {
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
                    'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
                    'Accept-Encoding': 'gzip, deflate, br',
                    'Connection': 'keep-alive',
                    'Upgrade-Insecure-Requests': '1'
                },
                onload: function(response) {
                    console.log("YT-Bili v2: æˆåŠŸè·å–Bç«™cookiesï¼ŒçŠ¶æ€ç :", response.status);
                    console.log("YT-Bili v2: å“åº”å¤´:", response.responseHeaders);
                    resolve();
                },
                onerror: function(error) {
                    console.error("YT-Bili v2: è·å–cookieså¤±è´¥:", error);
                    reject(error);
                }
            });
        });
    }

    /**
     * å¤‡ç”¨æœç´¢æ–¹æ³• - ä½¿ç”¨ä¸åŒçš„APIç«¯ç‚¹
     */
    function tryAlternativeSearch(originalQuery, searchTitle) {
        console.log("YT-Bili v2: å°è¯•å¤‡ç”¨æœç´¢æ–¹æ³•...");
        
        // å°è¯•ä¸åŒçš„APIç«¯ç‚¹
        const alternativeUrls = [
            `https://api.bilibili.com/x/web-interface/search/all/v2?keyword=${encodeURIComponent(searchTitle)}&page=1&pagesize=${CONFIG.MAX_SEARCH_RESULTS}`,
            `https://api.bilibili.com/x/web-interface/search/type?search_type=video&keyword=${encodeURIComponent(searchTitle)}&order=totalrank&duration=0&tids=0&single_column=0&page=1&pagesize=${CONFIG.MAX_SEARCH_RESULTS}`,
            `https://api.bilibili.com/x/web-interface/search/type?search_type=video&keyword=${encodeURIComponent(searchTitle)}&order=update&duration=0&tids=0&single_column=0&page=1&pagesize=${CONFIG.MAX_SEARCH_RESULTS}`
        ];
        
        let currentIndex = 0;
        
        function tryNextUrl() {
            if (currentIndex >= alternativeUrls.length) {
                console.log("YT-Bili v2: æ‰€æœ‰å¤‡ç”¨æ–¹æ³•éƒ½å¤±è´¥ï¼Œæä¾›ç›´æ¥è·³è½¬");
                handleSearchResult({ 
                    videos: [], 
                    totalSearched: 0, 
                    threshold: matcher.threshold, 
                    originalTitle: originalQuery,
                    fallbackUrl: `https://search.bilibili.com/video?keyword=${encodeURIComponent(searchTitle)}`
                });
                return;
            }
            
            const url = alternativeUrls[currentIndex];
            console.log(`YT-Bili v2: å°è¯•å¤‡ç”¨URL ${currentIndex + 1}:`, url);
            
            GM_xmlhttpRequest({
                method: 'GET',
                url: url,
                headers: {
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                    'Referer': 'https://www.bilibili.com/',
                    'Accept': 'application/json, text/plain, */*',
                    'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8'
                },
                onload: function(response) {
                    console.log(`YT-Bili v2: å¤‡ç”¨API ${currentIndex + 1} å“åº”çŠ¶æ€:`, response.status);
                    
                    if (response.status >= 200 && response.status < 300) {
                        try {
                            const data = JSON.parse(response.responseText);
                            
                            if (data.code === 0 && data.data && data.data.result) {
                                let videos = [];
                                
                                // å¤„ç†ä¸åŒçš„APIè¿”å›æ ¼å¼
                                if (currentIndex === 0) {
                                    // æ–°APIæ ¼å¼
                                    const allResults = data.data.result;
                                    if (allResults.video && allResults.video.data) {
                                        videos = allResults.video.data.slice(0, CONFIG.MAX_SEARCH_RESULTS);
                                    } else if (allResults.result && allResults.result.video && allResults.result.video.data) {
                                        videos = allResults.result.video.data.slice(0, CONFIG.MAX_SEARCH_RESULTS);
                                    } else if (Array.isArray(allResults)) {
                                        videos = allResults.slice(0, CONFIG.MAX_SEARCH_RESULTS);
                                    } else if (allResults.result && Array.isArray(allResults.result)) {
                                        videos = allResults.result.slice(0, CONFIG.MAX_SEARCH_RESULTS);
                                    }
                                } else {
                                    // æ—§APIæ ¼å¼
                                    videos = data.data.result.slice(0, CONFIG.MAX_SEARCH_RESULTS);
                                }
                                
                                // ç¡®ä¿è§†é¢‘æ•°æ®æ ¼å¼æ­£ç¡®
                                videos = videos.filter(video => video && video.title && video.bvid);
                                
                                console.log(`YT-Bili v2: å¤‡ç”¨æ–¹æ³• ${currentIndex + 1} æ‰¾åˆ° ${videos.length} ä¸ªè§†é¢‘`);
                                
                                if (videos.length > 0) {
                                    const rankedVideos = videos.map((video, index) => {
                                        const similarity = matcher.calculateStringSimilarity(originalQuery, video.title);
                                        return {
                                            ...video,
                                            similarity: similarity,
                                            rank: index + 1
                                        };
                                    })
                                    .filter(video => video.similarity >= matcher.threshold) // è¿‡æ»¤ä½åŒ¹é…åº¦ç»“æœ
                                    .sort((a, b) => b.similarity - a.similarity)
                                    .slice(0, CONFIG.MAX_SEARCH_RESULTS); // é™åˆ¶æ˜¾ç¤ºæ•°é‡
                                    
                                    console.log(`YT-Bili v2: å¤‡ç”¨æ–¹æ³• ${currentIndex + 1} è¿‡æ»¤åå‰©ä½™ ${rankedVideos.length} ä¸ªåŒ¹é…ç»“æœ`);
                                    
                                    if (rankedVideos.length > 0) {
                                        const result = {
                                            videos: rankedVideos,
                                            totalSearched: videos.length,
                                            threshold: matcher.threshold,
                                            originalTitle: originalQuery
                                        };
                                        
                                        handleSearchResult(result);
                                    } else {
                                        console.log(`YT-Bili v2: å¤‡ç”¨æ–¹æ³• ${currentIndex + 1} è¿‡æ»¤åæ— åŒ¹é…ç»“æœ`);
                                        currentIndex++;
                                        tryNextUrl();
                                    }
                                } else {
                                    console.log(`YT-Bili v2: å¤‡ç”¨æ–¹æ³• ${currentIndex + 1} ä¹Ÿæ— è§†é¢‘ç»“æœ`);
                                    currentIndex++;
                                    tryNextUrl();
                                }
                            } else {
                                console.log(`YT-Bili v2: å¤‡ç”¨æ–¹æ³• ${currentIndex + 1} ä¹Ÿæ— ç»“æœ`);
                                currentIndex++;
                                tryNextUrl();
                            }
                        } catch (error) {
                            console.error(`YT-Bili v2: å¤‡ç”¨æ–¹æ³• ${currentIndex + 1} è§£æå¤±è´¥:`, error);
                            currentIndex++;
                            tryNextUrl();
                        }
                    } else {
                        console.error(`YT-Bili v2: å¤‡ç”¨API ${currentIndex + 1} è¯·æ±‚å¤±è´¥:`, response.status);
                        currentIndex++;
                        tryNextUrl();
                    }
                },
                onerror: function() {
                    console.error(`YT-Bili v2: å¤‡ç”¨æ–¹æ³• ${currentIndex + 1} ç½‘ç»œè¯·æ±‚å¤±è´¥`);
                    currentIndex++;
                    tryNextUrl();
                }
            });
        }
        
        tryNextUrl();
    }

    /**
     * å¤„ç†æœç´¢ç»“æœ - æ˜¾ç¤ºé€‰æ‹©é¢æ¿
     */
    function handleSearchResult(result) {
        // ä¿å­˜å½“å‰æœç´¢ç»“æœ
        currentSearchResult = result;
        
        updateSearchButton(result);
        
        if (result.videos && result.videos.length > 0) {
            showResultsPanel(result);
        }
    }

    /**
     * æ›´æ–°æœç´¢æŒ‰é’®çŠ¶æ€
     */
    function updateSearchButton(result) {
        const button = document.getElementById(CONFIG.BUTTON_ID);
        if (!button) return;

        if (result.videos && result.videos.length > 0) {
            const bestMatch = result.videos[0];
            const color = bestMatch.similarity >= 0.7 ? '#4CAF50' : bestMatch.similarity >= 0.5 ? '#FFC107' : '#FF9800';
            
            button.innerHTML = `
                <div style="
                    position: fixed;
                    top: 12px;
                    right: 240px;
                    background: ${color};
                    color: white;
                    padding: 8px 12px;
                    border-radius: 6px;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    font-size: 12px;
                    cursor: pointer;
                    opacity: 0.9;
                    transition: opacity 0.3s;
                    white-space: nowrap;
                    z-index: 10000;
                " onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.9'">
                    ğŸ¯ ${result.videos.length}ä¸ªç»“æœ
                </div>
            `;
            
            button.onclick = (event) => {
                // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…å½±å“YouTubeæ’­æ”¾
                event.preventDefault();
                event.stopPropagation();
                toggleResultsPanel();
            };
        } else {
            const fallbackUrl = result.fallbackUrl || `https://search.bilibili.com/video?keyword=${encodeURIComponent(titleProcessor.generateSearchKeywords(currentVideoTitle).fullTitle)}`;
            
            button.innerHTML = `
                <div style="
                    position: fixed;
                    top: 12px;
                    right: 240px;
                    background: #FF9800;
                    color: white;
                    padding: 8px 12px;
                    border-radius: 6px;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    font-size: 12px;
                    cursor: pointer;
                    opacity: 0.9;
                    transition: opacity 0.3s;
                    white-space: nowrap;
                    z-index: 10000;
                " onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.9'">
                    ğŸ” Bilibili
                </div>
            `;
            
            button.onclick = (event) => {
                // é˜»æ­¢äº‹ä»¶å†’æ³¡
                event.preventDefault();
                event.stopPropagation();
                
                // æš‚åœYouTubeæ’­æ”¾ï¼ˆç”¨æˆ·è¦ç¦»å¼€é¡µé¢ï¼‰
                pauseYouTubeVideo();
                
                // è·³è½¬åˆ°Bilibiliæœç´¢é¡µé¢
                window.open(fallbackUrl, '_blank');
            };
        }
    }

    /**
     * æ˜¾ç¤ºæœç´¢ç»“æœé¢æ¿ - ä¼˜åŒ–UI
     */
    function showResultsPanel(result) {
        // ç§»é™¤å·²å­˜åœ¨çš„ç»“æœé¢æ¿
        document.getElementById(CONFIG.RESULTS_PANEL_ID)?.remove();

        const panel = document.createElement('div');
        panel.id = CONFIG.RESULTS_PANEL_ID;
        panel.style.cssText = `
            position: fixed;
            top: 80px;
            right: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 450px;
            max-height: 600px;
            overflow-y: auto;
            animation: slideIn 0.3s ease-out;
            border: 1px solid #e0e0e0;
        `;

        let panelContent = `
            <div style="padding: 20px; border-bottom: 1px solid #eee; background: linear-gradient(135deg, #f8f9fa, #ffffff);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h3 style="margin: 0; color: #333; font-size: 18px; font-weight: 600;">ğŸ¯ Bilibiliæœç´¢ç»“æœ</h3>
                    <button id="yt-bili-close-panel-v2" style="
                        background: none;
                        border: none;
                        font-size: 20px;
                        cursor: pointer;
                        color: #666;
                        padding: 0;
                        width: 28px;
                        height: 28px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 50%;
                        transition: background-color 0.2s;
                    " onmouseover="this.style.backgroundColor='#f0f0f0'" onmouseout="this.style.backgroundColor='transparent'">Ã—</button>
                </div>
                <div style="font-size: 13px; color: #666; margin-bottom: 8px;">
                    æ‰¾åˆ° ${result.videos.length} ä¸ªç»“æœï¼ŒæŒ‰ç›¸ä¼¼åº¦æ’åº
                </div>
                <div style="font-size: 12px; color: #999; font-style: italic;">
                    åŸå§‹æ ‡é¢˜: "${result.originalTitle}"
                </div>
            </div>
        `;

        if (result.videos && result.videos.length > 0) {
            result.videos.forEach((video, index) => {
                const similarity = video.similarity;
                const color = similarity >= 0.7 ? '#4CAF50' : similarity >= 0.5 ? '#FFC107' : '#FF9800';
                const rank = video.rank;
                
                // ç¡®ä¿è§†é¢‘ä¿¡æ¯å®Œæ•´
                const title = video.title || 'æœªçŸ¥æ ‡é¢˜';
                const author = video.author || 'æœªçŸ¥ä½œè€…';
                const duration = video.duration || 'æœªçŸ¥æ—¶é•¿';
                const bvid = video.bvid || '';
                
                panelContent += `
                    <div class="yt-bili-video-item-v2" data-bvid="${bvid}" style="
                        padding: 16px 20px;
                        border-bottom: 1px solid #f0f0f0;
                        cursor: pointer;
                        transition: all 0.2s;
                        position: relative;
                    " onmouseover="this.style.backgroundColor='#f8f9fa'; this.style.transform='translateX(-2px)'" onmouseout="this.style.backgroundColor='white'; this.style.transform='translateX(0)'">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                            <div style="font-weight: 500; color: #333; font-size: 14px; line-height: 1.4; flex: 1; margin-right: 12px;">
                                ${title}
                            </div>
                            <div style="
                                background: ${color};
                                color: white;
                                padding: 4px 8px;
                                border-radius: 6px;
                                font-size: 12px;
                                font-weight: 600;
                                white-space: nowrap;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                            ">
                                ${(similarity * 100).toFixed(0)}%
                            </div>
                        </div>
                        <div style="font-size: 12px; color: #666; margin-bottom: 6px;">
                            <span style="color: #00a1d6;">ğŸ‘¤</span> ${author} | <span style="color: #fb7299;">â±ï¸</span> ${duration} | <span style="color: #999;">#${rank}</span>
                        </div>
                        <div style="font-size: 11px; color: #999; display: flex; align-items: center;">
                            <span style="margin-right: 4px;">ğŸ”—</span> ç‚¹å‡»è·³è½¬åˆ°Bilibiliè§‚çœ‹
                            <span style="margin-left: auto; font-size: 10px; opacity: 0.7;">â†’</span>
                        </div>
                    </div>
                `;
            });
        } else {
            // æ²¡æœ‰åŒ¹é…ç»“æœæ—¶çš„æç¤º
            panelContent += `
                <div style="padding: 20px; text-align: center; color: #666;">
                    <div style="font-size: 16px; margin-bottom: 8px;">ğŸ”</div>
                    <div style="font-size: 14px; margin-bottom: 4px;">æœªæ‰¾åˆ°åŒ¹é…çš„è§†é¢‘</div>
                    <div style="font-size: 12px; color: #999;">åŒ¹é…åº¦ä½äº ${(matcher.threshold * 100).toFixed(1)}% çš„ç»“æœå·²è¢«è¿‡æ»¤</div>
                </div>
            `;
        }

        panelContent += `
            <div style="padding: 16px 20px; text-align: center; border-top: 1px solid #eee; background: #fafafa;">
                <button id="yt-bili-open-search-v2" style="
                    background: linear-gradient(135deg, #00a1d6, #fb7299);
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 13px;
                    font-weight: 500;
                    transition: transform 0.2s;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                " onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">åœ¨Bilibiliä¸­æœç´¢æ›´å¤šç»“æœ</button>
            </div>
        `;

        panel.innerHTML = panelContent;

        // æ·»åŠ åŠ¨ç”»æ ·å¼
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);

        // æ·»åŠ åˆ°é¡µé¢
        document.body.appendChild(panel);

        // ç»‘å®šäº‹ä»¶
        document.getElementById('yt-bili-close-panel-v2').addEventListener('click', (event) => {
            event.preventDefault();
            event.stopPropagation();
            panel.remove();
            console.log("YT-Bili v2: ç”¨æˆ·å…³é—­ç»“æœé¢æ¿");
        });

        document.getElementById('yt-bili-open-search-v2').addEventListener('click', (event) => {
            event.preventDefault();
            event.stopPropagation();
            
            // æš‚åœYouTubeæ’­æ”¾ï¼ˆç”¨æˆ·è¦ç¦»å¼€é¡µé¢ï¼‰
            pauseYouTubeVideo();
            
            const searchKeywords = titleProcessor.generateSearchKeywords(currentVideoTitle);
            const searchUrl = `https://search.bilibili.com/video?keyword=${encodeURIComponent(searchKeywords.fullTitle)}`;
            window.open(searchUrl, '_blank');
            panel.remove();
            console.log("YT-Bili v2: ç”¨æˆ·è·³è½¬åˆ°Bilibiliæœç´¢é¡µé¢");
        });

        // ç»‘å®šè§†é¢‘é¡¹ç‚¹å‡»äº‹ä»¶
        const videoItems = panel.querySelectorAll('.yt-bili-video-item-v2');
        videoItems.forEach(item => {
            item.addEventListener('click', (event) => {
                event.preventDefault();
                event.stopPropagation();
                
                // æš‚åœYouTubeæ’­æ”¾ï¼ˆç”¨æˆ·è¦è·³è½¬åˆ°Bilibiliè§†é¢‘ï¼‰
                pauseYouTubeVideo();
                
                const bvid = item.getAttribute('data-bvid');
                if (bvid) {
                    window.open(`https://www.bilibili.com/video/${bvid}`, '_blank');
                }
            });
        });

        // ç‚¹å‡»é¢æ¿å¤–éƒ¨å…³é—­
        document.addEventListener('click', function closePanel(e) {
            if (!panel.contains(e.target) && e.target.id !== CONFIG.BUTTON_ID) {
                panel.remove();
                document.removeEventListener('click', closePanel);
                console.log("YT-Bili v2: ç”¨æˆ·ç‚¹å‡»é¢æ¿å¤–éƒ¨å…³é—­");
            }
        });
    }

    /**
     * åˆ‡æ¢ç»“æœé¢æ¿æ˜¾ç¤º/éšè—
     */
    function toggleResultsPanel() {
        const panel = document.getElementById(CONFIG.RESULTS_PANEL_ID);
        if (panel) {
            panel.remove();
            console.log("YT-Bili v2: éšè—ç»“æœé¢æ¿");
        } else {
            // é‡æ–°æ˜¾ç¤ºé¢æ¿
            if (currentSearchResult && currentSearchResult.videos && currentSearchResult.videos.length > 0) {
                console.log("YT-Bili v2: é‡æ–°æ˜¾ç¤ºç»“æœé¢æ¿");
                showResultsPanel(currentSearchResult);
            } else {
                console.log("YT-Bili v2: æ— æœç´¢ç»“æœï¼Œé‡æ–°æœç´¢");
                // å¦‚æœæ²¡æœ‰æœç´¢ç»“æœï¼Œé‡æ–°æœç´¢
                if (currentVideoTitle) {
                    updateButtonToSearching();
                    searchBilibili(currentVideoTitle);
                } else {
                    console.log("YT-Bili v2: å½“å‰è§†é¢‘æ ‡é¢˜ä¸ºç©ºï¼Œæ— æ³•é‡æ–°æœç´¢");
                    alert('å½“å‰è§†é¢‘æ ‡é¢˜ä¸ºç©ºï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                }
            }
        }
    }

    /**
     * æµ‹è¯•Bilibili APIè¿æ¥
     */
    function testBilibiliAPI() {
        console.log("YT-Bili v2: å¼€å§‹æµ‹è¯•APIè¿æ¥...");
        
        // é¦–å…ˆè·å–cookies
        getBilibiliCookies().then(() => {
            const testUrl = 'https://api.bilibili.com/x/web-interface/wbi/search/all/v2?keyword=æµ‹è¯•&page=1&pagesize=5';
            
            GM_xmlhttpRequest({
                method: 'GET',
                url: testUrl,
                headers: {
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                    'Referer': 'https://www.bilibili.com/',
                    'Accept': 'application/json, text/plain, */*',
                    'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8'
                },
                onload: function(response) {
                    console.log("YT-Bili v2: APIæµ‹è¯•å“åº”çŠ¶æ€:", response.status);
                    console.log("YT-Bili v2: APIæµ‹è¯•å“åº”å†…å®¹:", response.responseText.substring(0, 1000));
                    
                    if (response.status >= 200 && response.status < 300) {
                        try {
                            const data = JSON.parse(response.responseText);
                            if (data.code === 0) {
                                alert(`APIè¿æ¥æˆåŠŸï¼\nçŠ¶æ€ç : ${response.status}\nè¿”å›æ•°æ®: ${JSON.stringify(data, null, 2).substring(0, 500)}`);
                            } else {
                                alert(`APIè¿æ¥æˆåŠŸä½†è¿”å›é”™è¯¯ï¼š\né”™è¯¯ç : ${data.code}\né”™è¯¯ä¿¡æ¯: ${data.message || 'æœªçŸ¥é”™è¯¯'}`);
                            }
                        } catch (error) {
                            alert(`APIè¿æ¥æˆåŠŸä½†è§£æå¤±è´¥ï¼š\n${error.message}\nåŸå§‹å“åº”ï¼š\n${response.responseText.substring(0, 500)}`);
                        }
                    } else {
                        alert(`APIè¿æ¥å¤±è´¥ï¼š\nçŠ¶æ€ç : ${response.status}\nå“åº”å†…å®¹ï¼š\n${response.responseText.substring(0, 500)}`);
                    }
                },
                onerror: function(error) {
                    alert(`APIç½‘ç»œè¯·æ±‚å¤±è´¥ï¼š\n${error.message || 'æœªçŸ¥ç½‘ç»œé”™è¯¯'}`);
                }
            });
        }).catch(error => {
            alert(`è·å–cookieså¤±è´¥ï¼š\n${error.message || 'æœªçŸ¥é”™è¯¯'}`);
        });
    }

    // åˆå§‹åŒ–
    setupMenuCommands();
    startUrlDetection();
    
    console.log('YouTube-Bilibili æ£€æµ‹å™¨æ²¹çŒ´è„šæœ¬ v2.3 å·²åŠ è½½');
    console.log(`é…ç½®: æœç´¢å‰${CONFIG.MAX_SEARCH_RESULTS}ä¸ªç»“æœï¼Œé»˜è®¤é˜ˆå€¼${(CONFIG.DEFAULT_THRESHOLD * 100).toFixed(1)}%`);
    console.log('åŸºäºå®˜æ–¹APIæ–‡æ¡£ä¼˜åŒ–ï¼Œè§£å†³412é”™è¯¯');
    console.log('æ–°å¢Cookieè·å–æœºåˆ¶ï¼Œç¡®ä¿APIæ­£å¸¸è®¿é—®');
    console.log('ä½¿ç”¨æ–°ç‰ˆç»¼åˆæœç´¢API: /x/web-interface/wbi/search/all/v2');
    console.log('æ™ºèƒ½è¿‡æ»¤ä½åŒ¹é…åº¦ç»“æœï¼Œé¿å…æ˜¾ç¤º"undefined"');
    console.log('å¢å¼ºçš„æ•°æ®è§£æï¼Œæ”¯æŒå¤šç§APIè¿”å›æ ¼å¼');
    console.log('ä¿®å¤é¢æ¿çŠ¶æ€ç®¡ç†ï¼Œè§£å†³è¿”å›åæŒ‰é’®æ— å“åº”é—®é¢˜');
    console.log('å¢å¼ºçš„è§†é¢‘åˆ‡æ¢æ£€æµ‹å·²å¯ç”¨');
    console.log('ç”¨æˆ·ç‚¹å‡»è§¦å‘æœç´¢æ¨¡å¼å·²å¯ç”¨');
    console.log('å¤šé‡å¤‡ç”¨æœç´¢æœºåˆ¶å·²å¯ç”¨');
    console.log('ä½¿ç”¨è¯´æ˜ï¼š');
    console.log('1. è®¿é—®YouTubeè§†é¢‘é¡µé¢');
    console.log('2. ç‚¹å‡»å³ä¸Šè§’çš„"ğŸ” Bilibili"æŒ‰é’®');
    console.log('3. ç­‰å¾…æœç´¢ç»“æœå¹¶é€‰æ‹©è·³è½¬');
    console.log('4. æˆ–ä½¿ç”¨èœå•ä¸­çš„"ç›´æ¥è·³è½¬Bilibiliæœç´¢"åŠŸèƒ½');
    console.log('5. å¦‚é‡APIé—®é¢˜ï¼Œå¯ä½¿ç”¨"æµ‹è¯•Bilibili APIè¿æ¥"èœå•å‘½ä»¤');
    console.log('6. ä½åŒ¹é…åº¦ç»“æœä¼šè‡ªåŠ¨è¿‡æ»¤ï¼Œåªæ˜¾ç¤ºé«˜è´¨é‡åŒ¹é…');
    console.log('7. ä»Bilibiliè¿”å›åï¼Œç‚¹å‡»ç»“æœæŒ‰é’®å¯é‡æ–°æ˜¾ç¤ºé¢æ¿');
})(); 
